#!/bin/bash

if [ "$(id -u)" != "0" ]; then
    echo "This script must be run as root."
    exit 2
fi

if [ $# -lt 1 ]; then
    echo "Usage: $0 <vid>"
    echo
    echo "Sets up dnsmasq on the specified cloudlet VID."
    echo
    echo "Uses the following DHCP range:"
    echo "    100.64.<vid>.10 through 100.64.<vid>.199"
    echo
    echo "To make IP addressing convenient, VIDs must be nubered from"
    echo "    1 <= vid <= 255"
    echo "(Usage of VLAN 1 is not recommended.)"
    exit 1
fi

VID=$1

STATE_DIR="/var/lib/maas-cloudlet/dnsmasq"
PID_FILE=$STATE_DIR/dnsmasq-vlan-$VID.pid

if [ -f "$PID_FILE" ]; then
    kill "$(cat $PID_FILE)" 2> /dev/null
fi

mkdir -p $STATE_DIR

# Pass empty DHCP options for 3 and 6 so that the client's
# DNS and default gateway aren't overwritten.
# Add '--no-daemon' to the parameters below for debugging.
ip netns exec tenant$VID dnsmasq \
    --port 0 \
    --pid-file=$PID_FILE \
    --dhcp-authoritative \
    --interface=veth$VID \
    --dhcp-range=100.64.$VID.10,100.64.$VID.199 \
    --listen-address=100.64.$VID.1 \
    --dhcp-leasefile=$STATE_DIR/vlan-$VID.leases \
    --except-interface=lo \
    --dhcp-option=3,100.64.$VID.1 \
    --dhcp-option=6,8.8.8.8 \
    --bind-dynamic

# Use these to provide *NO* router address or DNS address.
#    --dhcp-option=3 \
#    --dhcp-option=6 \
